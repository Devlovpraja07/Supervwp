<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGMI Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
     <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2ecc71; /* Vibrant Green */
            --dark-green: #27ae60;   /* Darker Green */
            --accent-yellow: #f1c40f; /* BGMI Yellow */
            --background-dark: #1e272e; /* Dark Slate Grey */
            --card-bg: #2c3e50;      /* Wet Asphalt */
            --text-light: #ecf0f1;   /* Clouds White */
            --text-medium: #bdc3c7; /* Silver */
            --border-color: #34495e; /* Belize Hole / Darker border */
            --danger-red: #e74c3c;
            --danger-dark: #c0392b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            display: flex; /* Use flexbox for main layout */
            flex-direction: column; /* Stack elements */
        }

         .admin-container {
            display: flex;
            flex: 1; /* Allow container to grow and fill height */
            width: 100%;
            max-width: 1400px; /* Optional: constrain max width on large screens */
            margin: 0 auto;
            background: linear-gradient(180deg, var(--background-dark) 0%, #222f37 100%);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
             /* Initially hidden, shown by JS if admin */
             display: none;
             flex-direction: row; /* Ensure flex row for side-nav and content */
        }

        /* --- Header --- */
        .admin-header {
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; border-bottom: 1px solid var(--border-color);
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            width: 100%;
             /* Adjust width for max-width container on larger screens */
             max-width: 1400px; /* Match admin-container */
             margin: 0 auto;
        }
        .admin-header h1 { font-size: 1.5em; color: var(--primary-green); text-shadow: 0 0 5px rgba(46, 204, 113, 0.5); }
        .admin-header .logout-btn {
             background: none; border: 1px solid var(--accent-yellow); color: var(--accent-yellow);
            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
        }
        .admin-header .logout-btn:hover { background-color: var(--accent-yellow); color: #000; }

        /* --- Side Navigation --- */
        .admin-side-nav {
            width: 250px;
            background-color: #1a252c;
            padding-top: 60px; /* Account for fixed header */
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
             flex-shrink: 0; /* Prevent shrinking */
             overflow-y: auto; /* Enable scrolling if nav items exceed height */
        }
        .admin-side-nav a {
            color: var(--text-light); text-decoration: none; padding: 15px 20px; display: block;
            font-size: 1.1em; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s, color 0.2s;
        }
        .admin-side-nav a:hover, .admin-side-nav a.active-nav-link { background-color: var(--primary-green); color: var(--background-dark); font-weight: bold; }
        .admin-side-nav a i { margin-right: 10px; width: 20px; text-align: center; }


        /* --- Main Content Area --- */
        .admin-content {
            flex-grow: 1; /* Allow content to take remaining space */
            padding: 20px;
             padding-top: 80px; /* Account for fixed header */
            overflow-y: auto; /* Enable scrolling within content */
            height: calc(100vh - 60px); /* Fill remaining height below header */
        }
        .admin-content section { display: none; padding-bottom: 30px; animation: fadeIn 0.5s ease-out; }
        .admin-content section.active-section { display: block; }
         @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 {
            font-size: 2em; color: var(--primary-green); margin-bottom: 25px; border-bottom: 2px solid var(--dark-green);
            padding-bottom: 10px; text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }

         /* --- Access Denied Message --- */
        #access-denied-message {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; text-align: center; flex-direction: column;
            padding: 20px;
        }
        #access-denied-message h2 {
             color: var(--danger-red);
             text-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
             border-bottom: none;
        }
        #access-denied-message p {
             font-size: 1.1em;
             color: var(--text-medium);
             margin-top: 10px;
        }


        /* --- Cards & Forms (Adapted from main app) --- */
         .card {
            background-color: var(--card-bg); border-radius: 10px; padding: 20px; margin-bottom: 20px;
            border: 1px solid var(--border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.95em; color: var(--text-medium); font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: #1a252c; color: var(--text-light); /* Darker background for inputs */
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.3);
        }
         .form-group textarea { min-height: 100px; resize: vertical; }


        /* --- Buttons (Adapted) --- */
        .btn {
            display: inline-block; padding: 10px 20px; border-radius: 5px;
            text-decoration: none; font-size: 1em; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s; border: none;
        }
        .btn-primary { background-color: var(--primary-green); color: var(--background-dark); }
        .btn-primary:hover { background-color: var(--dark-green); }
        .btn-secondary { background-color: var(--card-bg); color: var(--text-light); border: 1px solid var(--border-color);}
        .btn-secondary:hover { background-color: #3a506b; }
        .btn-danger { background-color: var(--danger-red); color: var(--text-light); }
        .btn-danger:hover { background-color: var(--danger-dark); }
        .btn-outline-primary { background: none; color: var(--primary-green); border: 1px solid var(--primary-green); }
         .btn-outline-primary:hover { background-color: var(--primary-green); color: var(--background-dark); }

        .btn-block { display: block; width: 100%; margin-top: 15px; }

        /* Specific button styles */
        #generate-code-form button[type="submit"] { margin-top: 15px; }
        .event-form button[type="submit"] { margin-top: 20px; }


        /* --- Tables --- */
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            background-color: #1a252c; /* Darker background for tables */
        }
        .data-table th, .data-table td {
            padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background-color: var(--dark-green); color: var(--background-dark); font-weight: bold;
            text-transform: uppercase; font-size: 0.9em;
        }
        .data-table tbody tr:hover {
            background-color: var(--card-bg);
        }
         .data-table td { font-size: 0.9em; color: var(--text-medium); }
         .data-table td .action-buttons button,
         .data-table td .action-buttons a {
             margin-right: 5px; padding: 5px 10px; font-size: 0.85em;
         }
        .data-table td .action-buttons button:last-child,
         .data-table td .action-buttons a:last-child { margin-right: 0; }

        /* Responsive Table (basic) */
        @media (max-width: 768px) {
            .admin-container { flex-direction: column; } /* Stack side nav and content */
             .admin-side-nav {
                 width: 100%; /* Full width on small screens */
                 padding-top: 0; /* Remove header padding */
                 height: auto; /* Auto height */
                 border-right: none;
                 border-bottom: 1px solid var(--border-color);
                 flex-direction: row; /* Arrange nav links horizontally */
                 overflow-x: auto; /* Enable horizontal scrolling for nav */
                 -webkit-overflow-scrolling: touch;
                 justify-content: flex-start; /* Align links to the start */
             }
             .admin-side-nav a {
                 flex-shrink: 0; /* Prevent shrinking */
                 padding: 10px 15px; /* Adjust padding */
                 border-bottom: none;
                 border-right: 1px solid var(--border-color); /* Add right border */
             }
             .admin-side-nav a:last-child { border-right: none; }

            .admin-content { padding-top: 20px; height: auto; } /* Adjust padding, auto height */


            .data-table th, .data-table td {
                 padding: 8px 10px;
             }
            .data-table thead { display: none; } /* Hide table header */
            .data-table tbody td {
                 display: block; /* Make rows stack */
                 text-align: right;
                 border-bottom: 1px dotted var(--border-color);
             }
            .data-table tbody td::before {
                 content: attr(data-label); /* Add label before data */
                 float: left;
                 font-weight: bold;
                 color: var(--text-light);
                 margin-right: 10px;
             }
             .data-table tbody tr { margin-bottom: 15px; display: block; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg);}
             .data-table tbody td:last-child { border-bottom: none; }
        }


        /* --- Modals (Adapted) --- */
        .modal {
            display: none; position: fixed; z-index: 1002; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
            align-items: center; justify-content: center; animation: fadeIn 0.3s;
             padding: 15px;
        }
         .modal.active { display: flex; }

        .modal-content {
            background-color: var(--card-bg); margin: auto; padding: 20px;
            border: 1px solid var(--border-color); border-radius: 10px;
            width: 90%; max-width: 600px; /* Wider modal for forms/tables */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
             animation: slideInFromTop 0.3s ease-out;
             max-height: 90vh; /* Limit modal height */
             overflow-y: auto; /* Enable modal content scrolling */
        }

         @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { color: var(--primary-green); margin: 0; }
        .close-modal-btn { color: var(--text-medium); font-size: 1.8em; font-weight: bold; background: none; border: none; cursor: pointer; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: var(--text-light); }


        /* --- Utility & Messages --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-medium { color: var(--text-medium); }
        .error-message { color: #e74c3c; font-size: 0.9em; margin-top: 10px; text-align: center; }
        .success-message { color: var(--primary-green); font-size: 0.9em; margin-top: 10px; text-align: center;}
        .info-message { color: var(--accent-yellow); font-size: 0.9em; margin-top: 10px; text-align: center;}

        .loader {
            border: 4px solid var(--border-color); border-top: 4px solid var(--primary-green);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    </style>
</head>
<body>

    <!-- Main Admin Panel Content (Hidden by default) -->
    <div id="admin-panel-content" class="admin-container">
        <header class="admin-header">
            <h1>BGMI Admin Dashboard</h1>
            <button id="admin-logout-button" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </header>

        <nav class="admin-side-nav">
            <a href="#dashboard" data-section="dashboard" class="nav-link active-nav-link"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="#redeem-codes" data-section="redeem-codes" class="nav-link"><i class="fas fa-gift"></i> Redeem Codes</a>
            <a href="#users" data-section="users" class="nav-link"><i class="fas fa-users"></i> Users</a>
            <a href="#events" data-section="events" class="nav-link"><i class="fas fa-calendar-alt"></i> Events</a>
            <a href="#support" data-section="support" class="nav-link"><i class="fas fa-headset"></i> Support Tickets</a>
             <!-- Link back to main app -->
            <a href="index.html" class="nav-link" target="_blank" style="margin-top: auto; border-top: 1px solid var(--border-color);"><i class="fas fa-mobile-alt"></i> View App</a>
        </nav>

        <main class="admin-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="active-section">
                <h2>Dashboard</h2>
                <div class="card">
                    <h3>Overview</h3>
                    <p>Welcome to the Admin Panel.</p>
                     <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                         <div class="card" style="flex: 1; min-width: 150px; padding: 15px; text-align: center; background-color: #3a506b;">
                             <h4 style="color: var(--primary-green);">Total Users</h4>
                             <p style="font-size: 1.5em;" id="dashboard-total-users"><i class="fas fa-spinner fa-spin"></i></p>
                         </div>
                          <div class="card" style="flex: 1; min-width: 150px; padding: 15px; text-align: center; background-color: #3a506b;">
                             <h4 style="color: var(--primary-green);">Active Events</h4>
                             <p style="font-size: 1.5em;" id="dashboard-active-events"><i class="fas fa-spinner fa-spin"></i></p>
                         </div>
                          <div class="card" style="flex: 1; min-width: 150px; padding: 15px; text-align: center; background-color: #3a506b;">
                             <h4 style="color: var(--primary-green);">Open Tickets</h4>
                             <p style="font-size: 1.5em;" id="dashboard-open-tickets"><i class="fas fa-spinner fa-spin"></i></p>
                         </div>
                     </div>
                </div>
                 <!-- More dashboard elements can be added -->
            </section>

            <!-- Redeem Codes Section -->
            <section id="redeem-codes">
                <h2>Redeem Codes</h2>
                <div class="card">
                    <h3>Generate New Code</h3>
                    <form id="generate-code-form">
                        <div class="form-group">
                            <label for="code-input">Code (Leave blank to auto-generate)</label>
                            <input type="text" id="code-input" placeholder="Optional: Enter custom code">
                        </div>
                        <div class="form-group">
                            <label for="reward-input">Reward Description (e.g., "100 UC", "Legendary Outfit")</label>
                            <input type="text" id="reward-input" required placeholder="Enter reward description">
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Code</button>
                        <p id="generate-code-message" class="info-message hidden"></p>
                    </form>
                </div>

                <div class="card">
                     <h3>Existing Codes</h3>
                     <div class="loader hidden" id="redeem-codes-loader"></div>
                     <p id="no-redeem-codes-message" class="info-message hidden">No redeem codes found.</p>
                     <table class="data-table hidden" id="redeem-codes-table">
                         <thead>
                             <tr>
                                 <th>Code</th>
                                 <th>Reward</th>
                                 <th>Usages</th>
                                 <th>Generated At</th>
                                 <th>Actions</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Redeem codes will be loaded here -->
                         </tbody>
                     </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users">
                <h2>Users</h2>
                 <div class="loader hidden" id="users-loader"></div>
                 <p id="no-users-message" class="info-message hidden">No users found.</p>
                 <table class="data-table hidden" id="users-table">
                     <thead>
                         <tr>
                             <th>Email</th>
                             <th>Display Name</th>
                             <th>Bio</th>
                             <th>Last Login</th>
                              <th>UID</th>
                         </tr>
                     </thead>
                     <tbody>
                         <!-- Users will be loaded here -->
                     </tbody>
                 </table>
                 <!-- User details modal can be added here later -->
            </section>

            <!-- Events Section -->
            <section id="events">
                <h2>Events</h2>
                <div class="card">
                    <button class="btn btn-primary" id="show-add-event-modal-btn"><i class="fas fa-plus"></i> Add New Event</button>
                </div>
                <div class="card">
                    <h3>Upcoming Events</h3>
                    <div class="loader hidden" id="events-loader"></div>
                    <p id="no-events-message" class="info-message hidden">No events found.</p>
                    <table class="data-table hidden" id="events-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Reward</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Events will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Support Tickets Section -->
            <section id="support">
                <h2>Support Tickets</h2>
                 <div class="loader hidden" id="support-loader"></div>
                 <p id="no-support-message" class="info-message hidden">No support tickets found.</p>
                 <table class="data-table hidden" id="support-table">
                     <thead>
                         <tr>
                             <th>Submitted By</th>
                             <th>Subject</th>
                             <th>Message</th>
                             <th>Status</th>
                             <th>Submitted At</th>
                              <!-- Add Action column for status change later -->
                         </tr>
                     </thead>
                     <tbody>
                         <!-- Support tickets will be loaded here -->
                     </tbody>
                 </table>
            </section>

        </main>
    </div>

    <!-- Access Denied Message -->
    <div id="access-denied-message" class="hidden">
         <h2>Access Denied</h2>
         <p>You do not have sufficient privileges to view this page.</p>
         <p style="margin-top: 20px;">Please <a href="#" id="access-denied-login-link" style="color: var(--primary-green); text-decoration: none; font-weight: bold;">log in</a> with an admin account.</p>
         <p style="font-size: 0.8em; color: var(--text-medium); margin-top: 10px;">(Ensure your logged-in account has the 'isAdmin: true' flag in the Firebase Realtime Database.)</p>
    </div>


    <!-- Modals -->
    <!-- Add/Edit Event Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="event-modal-title">Add Event</h3>
                <button class="close-modal-btn" data-modal-id="event-modal">×</button>
            </div>
            <form id="event-form">
                <input type="hidden" id="event-id"> <!-- Hidden field for editing -->
                <div class="form-group">
                    <label for="event-title">Title</label>
                    <input type="text" id="event-title" required>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" required></textarea>
                </div>
                 <div class="form-group">
                    <label for="event-image-url">Image URL (Optional)</label>
                    <input type="url" id="event-image-url" placeholder="http://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="event-date">Date</label>
                    <input type="date" id="event-date" required>
                </div>
                <div class="form-group">
                    <label for="event-time">Time</label>
                    <input type="time" id="event-time">
                </div>
                 <div class="form-group">
                    <label for="event-reward">Reward (Optional)</label>
                    <input type="text" id="event-reward" placeholder="e.g., 500 UC">
                </div>
                 <div class="form-group">
                    <label for="event-link">Details Link (Optional)</label>
                    <input type="url" id="event-link" placeholder="http://example.com/details">
                </div>
                 <div class="form-group">
                    <label for="event-registration-link">Registration Link (Optional)</label>
                    <input type="url" id="event-registration-link" placeholder="http://example.com/register">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Save Event</button>
                <p id="event-form-message" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <!-- Simple Login Modal for Access Denied Link -->
    <div id="access-denied-login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Admin Login</h3><button class="close-modal-btn" data-modal-id="access-denied-login-modal">×</button></div>
            <form id="access-denied-login-form">
                <div class="form-group">
                    <label for="access-denied-email">Email</label>
                    <input type="email" id="access-denied-email" required>
                </div>
                <div class="form-group">
                    <label for="access-denied-password">Password</label>
                    <input type="password" id="access-denied-password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Login</button>
                 <button type="button" id="access-denied-google-login-btn" class="btn google-btn btn-block" style="background: linear-gradient(45deg, #dd4b39, #c23321);"><i class="fab fa-google"></i> Sign in with Google</button>
                <p id="access-denied-login-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>



    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Your Firebase project configuration - Updated with your provided JSON data
        const firebaseConfig = {
            apiKey: "AIzaSyD6EXA7D77rQDQEohB52BvTYimFeTEaAho", // From your JSON
            authDomain: "rn-gfx-tool.firebaseapp.com", // Derived from project_id
            databaseURL: "https://rn-gfx-tool-default-rtdb.asia-southeast1.firebasedatabase.app", // From your JSON
            projectId: "rn-gfx-tool", // From your JSON
            storageBucket: "rn-gfx-tool.firebasestorage.app", // From your JSON
            messagingSenderId: "163149358541", // From your JSON (project_number)
            appId: "1:163149358541:android:2ef6d22fcd23e77ee09084", // From your JSON (mobilesdk_app_id - Android app ID, but often works for web)
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();


        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const adminPanelContent = document.getElementById('admin-panel-content');
            const accessDeniedMessage = document.getElementById('access-denied-message');
            const adminLogoutButton = document.getElementById('admin-logout-button');
            const adminSideNavLinks = document.querySelectorAll('.admin-side-nav .nav-link');
            const adminContentSections = document.querySelectorAll('.admin-content section');

            // Modals & Forms
            const eventModal = document.getElementById('event-modal');
            const eventModalTitle = document.getElementById('event-modal-title');
            const eventForm = document.getElementById('event-form');
            const eventFormMessage = document.getElementById('event-form-message');
            const showAddEventModalBtn = document.getElementById('show-add-event-modal-btn');

            // Access Denied Login Modal
            const accessDeniedLoginLink = document.getElementById('access-denied-login-link');
            const accessDeniedLoginModal = document.getElementById('access-denied-login-modal');
            const accessDeniedLoginForm = document.getElementById('access-denied-login-form');
            const accessDeniedGoogleLoginBtn = document.getElementById('access-denied-google-login-btn');
            const accessDeniedLoginError = document.getElementById('access-denied-login-error');


            // Redeem Code Elements
            const generateCodeForm = document.getElementById('generate-code-form');
            const codeInput = document.getElementById('code-input');
            const rewardInput = document.getElementById('reward-input');
            const generateCodeMessage = document.getElementById('generate-code-message');
            const redeemCodesLoader = document.getElementById('redeem-codes-loader');
            const redeemCodesTable = document.getElementById('redeem-codes-table');
            const noRedeemCodesMessage = document.getElementById('no-redeem-codes-message');
            const redeemCodesTableBody = redeemCodesTable ? redeemCodesTable.querySelector('tbody') : null;

            // Users Elements
            const usersLoader = document.getElementById('users-loader');
            const usersTable = document.getElementById('users-table');
            const noUsersMessage = document.getElementById('no-users-message');
             const usersTableBody = usersTable ? usersTable.querySelector('tbody') : null;

            // Events Elements
            const eventsLoader = document.getElementById('events-loader');
            const eventsTable = document.getElementById('events-table');
            const noEventsMessage = document.getElementById('no-events-message');
             const eventsTableBody = eventsTable ? eventsTable.querySelector('tbody') : null;


            // Support Elements
            const supportLoader = document.getElementById('support-loader');
            const supportTable = document.getElementById('support-table');
            const noSupportMessage = document.getElementById('no-support-message');
             const supportTableBody = supportTable ? supportTable.querySelector('tbody') : null;

            // Dashboard Elements
            const dashboardTotalUsers = document.getElementById('dashboard-total-users');
            const dashboardActiveEvents = document.getElementById('dashboard-active-events');
            const dashboardOpenTickets = document.getElementById('dashboard-open-tickets');


            // --- Helper Functions ---

             // Function to show a specific section and hide others
            function showSection(sectionId) {
                adminContentSections.forEach(section => {
                    section.classList.remove('active-section');
                    section.style.animation = 'none'; // Reset animation
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active-section');
                     targetSection.style.animation = 'fadeIn 0.5s ease-out'; // Apply animation

                    // Update active class on side nav links
                    adminSideNavLinks.forEach(link => {
                        if (link.getAttribute('data-section') === sectionId) {
                            link.classList.add('active-nav-link');
                        } else {
                            link.classList.remove('active-nav-link');
                        }
                    });

                    // Trigger data load for the section
                    loadSectionData(sectionId);

                     // Scroll to top of the content area
                    const adminContent = document.querySelector('.admin-content');
                    if (adminContent) {
                        adminContent.scrollTop = 0;
                    }
                }
            }


            // Function to open a modal
            function openModal(modalElement) {
                 closeAllModals(); // Ensure only one modal is open
                 modalElement.classList.add('active');
            }

             // Function to close a modal
            function closeModal(modalElement) {
                 modalElement.classList.remove('active');
                 // Reset forms and hide messages when modal closes
                 const form = modalElement.querySelector('form');
                 if(form) {
                     form.reset();
                     // Reset hidden input for editing
                     if(form.id === 'event-form') {
                          document.getElementById('event-id').value = '';
                     }
                      // Reset login form error messages if closing login modal
                      if(modalElement.id === 'access-denied-login-modal'){
                          accessDeniedLoginError.classList.add('hidden');
                          accessDeniedLoginError.textContent = '';
                      }
                 }
                 const messageElement = modalElement.querySelector('.error-message, .success-message, .info-message');
                 if(messageElement) {
                      messageElement.classList.add('hidden');
                      messageElement.textContent = '';
                 }
            }

            // Function to close all modals
             function closeAllModals() {
                 document.querySelectorAll('.modal').forEach(modal => {
                     modal.classList.remove('active'); // Directly remove active class
                 });
             }

            // Generate a random alphanumeric code
            function generateRandomCode(length = 6) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

             // Format timestamp for display
             function formatTimestamp(timestamp) {
                 if (!timestamp) return 'N/A';
                 // Ensure timestamp is a number (Firebase ServerValue.TIMESTAMP is a number)
                 // Handle potential {'.sv': 'timestamp'} before resolution, use current time as fallback
                 const time = typeof timestamp === 'object' && timestamp !== null && typeof timestamp['.sv'] === 'string' ? new Date().getTime() : timestamp;
                 const date = new Date(time);
                 if (isNaN(date.getTime())) return 'Invalid Date'; // Check for invalid date
                 return date.toLocaleString(); // Use user's locale
             }


            // --- Admin Authentication & Access Control ---

            // Check auth state on load and when it changes
            auth.onAuthStateChanged(user => {
                console.log("Admin Auth state changed:", user ? user.uid : "Logged out");
                if (user) {
                    // User is logged in, now check if they are an admin
                    checkAdminStatus(user.uid);
                } else {
                    // User is logged out or not logged in
                    showAccessDenied(); // Show denied message if not logged in
                }
            });

            // Check if the logged-in user is an admin
            function checkAdminStatus(uid) {
                 // IMPORTANT: This read requires Firebase Rules to allow the authenticated user to read their own isAdmin flag.
                 // The provided rules should allow: ".read": "auth != null && ($uid === auth.uid || root.child('users').child(auth.uid).child('isAdmin').val() === true)",
                 // This allows the logged-in user ($uid === auth.uid) to read their own isAdmin status.
                 database.ref('users/' + uid + '/isAdmin').once('value', (snapshot) => {
                     if (snapshot.exists() && snapshot.val() === true) {
                         // User is an admin
                         console.log("Admin login successful:", uid);
                         showAdminPanel();
                     } else {
                         // User is logged in but not an admin
                         console.warn("User is not an admin:", uid);
                          // Optionally, sign out non-admin users automatically
                           auth.signOut().then(() => {
                              console.log("Signed out non-admin user.");
                              showAccessDenied(); // Show denied message after signing out
                           }).catch(error => {
                               console.error("Error signing out non-admin:", error);
                               showAccessDenied(); // Still show denied message even if sign out fails
                           });
                     }
                 }, (errorObject) => {
                     console.error("Error checking admin status:", errorObject);
                      // Log out the user if admin check fails due to database error
                     auth.signOut().then(() => {
                          console.log("Signed out user after admin check error.");
                          alert("Could not verify admin status due to a database error. Please try again.");
                          showAccessDenied(); // Show denied message
                     }).catch(error => {
                         console.error("Error signing out after admin check failure:", error);
                          showAccessDenied(); // Show denied message
                     });
                 });
            }

            // Show Access Denied message
            function showAccessDenied() {
                adminPanelContent.style.display = 'none'; // Hide the flex container
                accessDeniedMessage.classList.remove('hidden');
                 // Ensure any open modals are closed
                closeAllModals();
            }

            // Show admin panel
            function showAdminPanel() {
                 accessDeniedMessage.classList.add('hidden');
                adminPanelContent.style.display = 'flex'; // Show the flex container
                 // Show default section (Dashboard)
                showSection('dashboard');
                 // Ensure any open modals are closed
                 closeAllModals();
            }


            // --- Navigation ---
            adminSideNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.getAttribute('data-section');
                    showSection(sectionId);
                });
            });


            // --- Data Loading and Management per Section ---

            // Store listeners globally to detach them when switching sections
            window._redeemCodeListener = null;
            window._usersListener = null;
            window._eventsListener = null;
            window._supportTicketsListener = null;


            function loadSectionData(sectionId) {
                // Detach *all* listeners from other sections before loading the current one
                // This prevents multiple listeners running simultaneously on different sections.
                 if (window._redeemCodeListener) {
                     database.ref('redeem_codes').off('value', window._redeemCodeListener);
                     window._redeemCodeListener = null;
                     console.log("Detached redeem code listener.");
                 }
                 if (window._usersListener) {
                      database.ref('users').off('value', window._usersListener);
                     window._usersListener = null;
                      console.log("Detached users listener.");
                 }
                 if (window._eventsListener) {
                     database.ref('events').off('value', window._eventsListener);
                     window._eventsListener = null;
                      console.log("Detached events listener.");
                 }
                 if (window._supportTicketsListener) {
                      database.ref('support_tickets').off('value', window._supportTicketsListener);
                     window._supportTicketsListener = null;
                      console.log("Detached support tickets listener.");
                 }

                 // Now load data only for the active section
                switch (sectionId) {
                    case 'dashboard':
                        loadDashboardStats(); // Dashboard uses once(), no persistent listener needed
                        break;
                    case 'redeem-codes':
                        loadRedeemCodes(); // This function will attach a new 'on' listener
                        break;
                    case 'users':
                        loadUsers(); // This function will attach a new 'on' listener
                        break;
                    case 'events':
                        loadEvents(); // This function will attach a new 'on' listener
                        break;
                    case 'support':
                        loadSupportTickets(); // This function will attach a new 'on' listener
                        break;
                     default:
                        console.warn("Attempted to load data for unknown section:", sectionId);
                        // Maybe show a "section not found" message
                        break;
                }
            }

            // Dashboard Stats
            function loadDashboardStats() {
                 // Use once() for dashboard stats as they don't need real-time updates constantly
                database.ref('users').once('value', (snapshot) => {
                     const userCount = snapshot.exists() ? snapshot.numChildren() : 0;
                     dashboardTotalUsers.textContent = userCount;
                }, (error) => {
                    console.error("Failed to load user count:", error);
                     dashboardTotalUsers.textContent = 'Error';
                });

                 // Load active events count (simple count of all events for now)
                 database.ref('events').once('value', (snapshot) => {
                     const eventCount = snapshot.exists() ? snapshot.numChildren() : 0;
                     dashboardActiveEvents.textContent = eventCount;
                 }, (error) => {
                    console.error("Failed to load event count:", error);
                     dashboardActiveEvents.textContent = 'Error';
                 });

                 // Load open support tickets count (assuming status field exists and is 'open')
                 database.ref('support_tickets').orderByChild('status').equalTo('open').once('value', (snapshot) => {
                     const openTicketCount = snapshot.exists() ? snapshot.numChildren() : 0;
                     dashboardOpenTickets.textContent = openTicketCount;
                 }, (error) => {
                    console.error("Failed to load open tickets count:", error);
                     dashboardOpenTickets.textContent = 'Error';
                 });
            }


            // Redeem Codes Management
            function loadRedeemCodes() {
                if (!redeemCodesTableBody) return; // Exit if element not found

                redeemCodesTableBody.innerHTML = ''; // Clear existing data
                redeemCodesTable.classList.add('hidden');
                noRedeemCodesMessage.classList.add('hidden');
                generateCodeMessage.classList.add('hidden'); // Hide message from generate form when section loads
                redeemCodesLoader.classList.remove('hidden');

                 // Use 'on' for real-time updates
                 if (window._redeemCodeListener) { // Detach previous listener if exists
                     database.ref('redeem_codes').off('value', window._redeemCodeListener);
                     window._redeemCodeListener = null;
                 }

                 const redeemCodeCallback = (snapshot) => {
                     redeemCodesLoader.classList.add('hidden');
                     redeemCodesTableBody.innerHTML = ''; // Clear again for real-time updates

                     if (snapshot.exists()) {
                        const codes = snapshot.val();
                        const codeKeys = Object.keys(codes);

                         if (codeKeys.length === 0) {
                            noRedeemCodesMessage.classList.remove('hidden');
                            redeemCodesTable.classList.add('hidden');
                            return;
                        }

                        redeemCodesTable.classList.remove('hidden');
                        noRedeemCodesMessage.classList.add('hidden');

                         // Sort codes by generatedAt timestamp (most recent first)
                         codeKeys.sort((a, b) => {
                             const timeA = codes[a].generatedAt || 0;
                             const timeB = codes[b].generatedAt || 0;
                             return timeB - timeA; // Descending sort
                         });


                        codeKeys.forEach(key => {
                            const code = codes[key];
                            const row = `
                                <tr>
                                    <td data-label="Code">${key}</td>
                                    <td data-label="Reward">${code.reward || 'N/A'}</td>
                                    <td data-label="Usages">${code.usedCount || 0}</td>
                                    <td data-label="Generated At">${formatTimestamp(code.generatedAt)}</td>
                                    <td data-label="Actions" class="action-buttons">
                                        <button class="btn btn-secondary btn-sm copy-code-btn" data-code="${key}">Copy</button>
                                        <button class="btn btn-danger btn-sm delete-code-btn" data-code="${key}">Delete</button>
                                    </td>
                                </tr>
                            `;
                            redeemCodesTableBody.innerHTML += row;
                        });

                        // Add listeners for copy and delete buttons after rendering
                        attachRedeemCodeListeners();

                     } else {
                         noRedeemCodesMessage.classList.remove('hidden');
                         redeemCodesTable.classList.add('hidden');
                     }
                 };

                 database.ref('redeem_codes').on('value', redeemCodeCallback, (error) => {
                     console.error("Failed to load redeem codes:", error);
                     redeemCodesLoader.classList.add('hidden');
                     noRedeemCodesMessage.classList.add('hidden');
                     redeemCodesTable.classList.add('hidden');
                     if (redeemCodesTableBody) {
                         redeemCodesTableBody.innerHTML = `<tr><td colspan="5" class="error-message" data-label="Error">Failed to load codes: ${error.message}</td></tr>`;
                     }
                 });

                 window._redeemCodeListener = redeemCodeCallback; // Store listener for detachment
            }


         function attachRedeemCodeListeners() {
             // Using event delegation on the table body
             if (redeemCodesTableBody) {
                 // Remove previous listener before adding to avoid duplicates
                 redeemCodesTableBody.removeEventListener('click', handleRedeemCodeActions);
                 redeemCodesTableBody.addEventListener('click', handleRedeemCodeActions);
             }
         }

         function handleRedeemCodeActions(e) {
             const target = e.target;
             // Traverse up to find the button with data-id
             const button = target.closest('button');
             if (!button) return;

             const code = button.dataset.code;

             if (!code) return;

             if (button.classList.contains('copy-code-btn')) {
                 // Copy code to clipboard
                 navigator.clipboard.writeText(code).then(() => {
                     alert(`Code "${code}" copied to clipboard!`);
                 }).catch(err => {
                     console.error('Failed to copy code:', err);
                     alert('Failed to copy code. Please copy manually: ' + code);
                 });
             } else if (button.classList.contains('delete-code-btn')) {
                 // Delete code
                 if (confirm(`Are you sure you want to delete code "${code}"?`)) {
                     database.ref('redeem_codes/' + code).remove()
                         .then(() => console.log(`Code "${code}" deleted.`))
                         .catch(error => console.error(`Error deleting code "${code}":`, error));
                 }
             }
         }


        generateCodeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = codeInput.value.trim().toUpperCase() || generateRandomCode(6); // Auto-generate or use custom (uppercase)
            const reward = rewardInput.value.trim();
            generateCodeMessage.classList.add('hidden');
            generateCodeMessage.textContent = ''; // Clear message
            generateCodeMessage.classList.remove('error-message', 'success-message', 'info-message');

            if (!reward) {
                 generateCodeMessage.textContent = "Reward description is required.";
                 generateCodeMessage.classList.add('error-message');
                 generateCodeMessage.classList.remove('hidden');
                 return;
            }

            // Check if code already exists before saving
            database.ref('redeem_codes/' + code).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        generateCodeMessage.textContent = `Code "${code}" already exists. Please use a different one or leave blank for auto-generate.`;
                        generateCodeMessage.classList.add('error-message');
                        generateCodeMessage.classList.remove('hidden');
                    } else {
                        // Save the new code
                        database.ref('redeem_codes/' + code).set({
                            reward: reward,
                            generatedAt: firebase.database.ServerValue.TIMESTAMP,
                            usedCount: 0 // Initialize usage count
                        }).then(() => {
                            generateCodeMessage.textContent = `Code "${code}" generated successfully with reward "${reward}".`;
                            generateCodeMessage.classList.add('success-message');
                            generateCodeMessage.classList.remove('hidden');
                            generateCodeForm.reset();
                            console.log("Code generated:", code);
                        }).catch(error => {
                            generateCodeMessage.textContent = `Failed to generate code: ${error.message}`;
                            generateCodeMessage.classList.add('error-message');
                            generateCodeMessage.classList.remove('hidden');
                            console.error("Error generating code:", error);
                        });
                    }
                })
                .catch(error => {
                    generateCodeMessage.textContent = `Error checking code existence: ${error.message}`;
                    generateCodeMessage.classList.add('error-message');
                    generateCodeMessage.classList.remove('hidden');
                    console.error("Error checking code existence:", error);
                });
        });


        // User Management
        function loadUsers() {
             if (!usersTableBody) return; // Exit if element not found

             usersTableBody.innerHTML = ''; // Clear existing data
             usersTable.classList.add('hidden');
             noUsersMessage.classList.add('hidden');
             usersLoader.classList.remove('hidden');

             // Use 'on' for real-time updates
             if (window._usersListener) { // Detach previous listener if exists
                 database.ref('users').off('value', window._usersListener);
                 window._usersListener = null;
             }

             const usersCallback = (snapshot) => {
                 usersLoader.classList.add('hidden');
                 usersTableBody.innerHTML = ''; // Clear again for real-time updates

                 if (snapshot.exists()) {
                     const users = snapshot.val();
                     const userKeys = Object.keys(users);

                     if (userKeys.length === 0) {
                        noUsersMessage.classList.remove('hidden');
                        usersTable.classList.add('hidden');
                        return;
                    }

                     usersTable.classList.remove('hidden');
                     noUsersMessage.classList.add('hidden');

                      // Sort users by last login (most recent first)
                      userKeys.sort((a, b) => {
                          const timeA = users[a].lastLogin || 0;
                          const timeB = users[b].lastLogin || 0;
                          return timeB - timeA; // Descending sort
                      });


                     userKeys.forEach(key => {
                         const user = users[key];
                         const row = `
                             <tr>
                                 <td data-label="Email">${user.email || 'N/A'}</td>
                                 <td data-label="Display Name">${user.displayName || 'N/A'}</td>
                                 <td data-label="Bio">${user.bio || 'N/A'}</td>
                                 <td data-label="Last Login">${formatTimestamp(user.lastLogin)}</td>
                                 <td data-label="UID" style="font-size: 0.7em; color: var(--text-medium);">${key}</td>
                                  <!-- Add Action buttons here for edit/delete if needed -->
                             </tr>
                         `;
                         usersTableBody.innerHTML += row;
                     });

                 } else {
                     noUsersMessage.classList.remove('hidden');
                     usersTable.classList.add('hidden');
                 }
             };

             database.ref('users').on('value', usersCallback, (error) => {
                console.error("Failed to load users:", error);
                usersLoader.classList.add('hidden');
                noUsersMessage.classList.add('hidden');
                usersTable.classList.add('hidden');
                 if (usersTableBody) {
                    usersTableBody.innerHTML = `<tr><td colspan="5" class="error-message" data-label="Error">Failed to load users: ${error.message}</td></tr>`;
                 }
             });
             window._usersListener = usersCallback; // Store listener
        }


        // Event Management
        function loadEvents() {
            if (!eventsTableBody) return; // Exit if element not found

            eventsTableBody.innerHTML = ''; // Clear existing data
            eventsTable.classList.add('hidden');
            noEventsMessage.classList.add('hidden');
            eventsLoader.classList.remove('hidden');
            eventFormMessage.classList.add('hidden'); // Hide form message when section loads


            // Use 'on' for real-time updates
             if (window._eventsListener) { // Detach previous listener if exists
                 database.ref('events').off('value', window._eventsListener);
                 window._eventsListener = null;
             }

             const eventsCallback = (snapshot) => {
                 eventsLoader.classList.add('hidden');
                 eventsTableBody.innerHTML = ''; // Clear again for real-time updates

                 if (snapshot.exists()) {
                    const events = snapshot.val();
                    const eventKeys = Object.keys(events);

                     if (eventKeys.length === 0) {
                        noEventsMessage.classList.remove('hidden');
                        eventsTable.classList.add('hidden');
                        return;
                    }

                    eventsTable.classList.remove('hidden');
                    noEventsMessage.classList.add('hidden');

                    // Sort events by date (assuming date format is sortable YYYY-MM-DD)
                     eventKeys.sort((a, b) => {
                        const dateA = new Date(events[a].date || '1970-01-01');
                        const dateB = new Date(events[b].date || '1970-01-01');
                        // Sort upcoming events first, then older ones reverse chronologically
                         const now = new Date();
                         const isUpcomingA = dateA.getTime() >= now.getTime(); // Use getTime() for comparison
                         const isUpcomingB = dateB.getTime() >= now.getTime();

                         if (isUpcomingA && !isUpcomingB) return -1; // A is upcoming, B is not
                         if (!isUpcomingA && isUpcomingB) return 1;  // B is upcoming, A is not

                         if (isUpcomingA && isUpcomingB) return dateA.getTime() - dateB.getTime(); // Both upcoming, sort ascending by time
                         if (!isUpcomingA && !isUpcomingB) return dateB.getTime() - dateA.getTime(); // Both past, sort descending by time (most recent past first)

                         return 0; // Should not happen
                     });


                    eventKeys.forEach(key => {
                        const event = events[key];
                        const row = `
                            <tr>
                                <td data-label="Title">${event.title || 'Untitled'}</td>
                                <td data-label="Date">${event.date || 'N/A'}</td>
                                <td data-label="Time">${event.time || 'N/A'}</td>
                                <td data-label="Reward">${event.reward || 'N/A'}</td>
                                <td data-label="Actions" class="action-buttons">
                                    <button class="btn btn-secondary btn-sm edit-event-btn" data-id="${key}">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-event-btn" data-id="${key}">Delete</button>
                                </td>
                            </tr>
                        `;
                        eventsTableBody.innerHTML += row;
                    });

                    // Add listeners for edit and delete buttons
                    attachEventListeners();

                 } else {
                     noEventsMessage.classList.remove('hidden');
                     eventsTable.classList.add('hidden');
                 }
             };

             database.ref('events').on('value', eventsCallback, (error) => {
                console.error("Failed to load events:", error);
                eventsLoader.classList.add('hidden');
                noEventsMessage.classList.add('hidden');
                eventsTable.classList.add('hidden');
                if (eventsTableBody) {
                    eventsTableBody.innerHTML = `<tr><td colspan="5" class="error-message" data-label="Error">Failed to load events: ${error.message}</td></tr>`;
                }
             });
             window._eventsListener = eventsCallback; // Store listener
        }

         function attachEventListeners() {
             // Using event delegation on the table body
             if (eventsTableBody) {
                 // Remove previous listener before adding to avoid duplicates
                 eventsTableBody.removeEventListener('click', handleEventActions);
                 eventsTableBody.addEventListener('click', handleEventActions);
             }
         }

         function handleEventActions(e) {
             const target = e.target;
             // Traverse up to find the button with data-id
             const button = target.closest('button');
             if (!button) return;

             const eventId = button.dataset.id;

             if (!eventId) return;

             if (button.classList.contains('edit-event-btn')) {
                 // Load event data into modal for editing
                 database.ref('events/' + eventId).once('value').then(snapshot => {
                     if (snapshot.exists()) {
                         const eventData = snapshot.val();
                         eventModalTitle.textContent = 'Edit Event';
                         document.getElementById('event-id').value = eventId;
                         document.getElementById('event-title').value = eventData.title || '';
                         document.getElementById('event-description').value = eventData.description || '';
                         document.getElementById('event-image-url').value = eventData.imageUrl || '';
                         document.getElementById('event-date').value = eventData.date || ''; // Assumes date is YYYY-MM-DD
                         document.getElementById('event-time').value = eventData.time || '';
                         document.getElementById('event-reward').value = eventData.reward || '';
                         document.getElementById('event-link').value = eventData.link || '';
                         document.getElementById('event-registration-link').value = eventData.registrationLink || '';

                         openModal(eventModal);
                     } else {
                         alert('Event not found!');
                     }
                 }).catch(error => {
                     console.error("Error loading event for edit:", error);
                     alert('Failed to load event data.');
                 });

             } else if (button.classList.contains('delete-event-btn')) {
                 // Delete event
                 if (confirm(`Are you sure you want to delete this event?`)) {
                     database.ref('events/' + eventId).remove()
                         .then(() => console.log(`Event "${eventId}" deleted.`))
                         .catch(error => console.error(`Error deleting event "${eventId}":`, error));
                 }
             }
         }

        // Show Add Event Modal
        showAddEventModalBtn.addEventListener('click', () => {
             eventModalTitle.textContent = 'Add Event';
             eventForm.reset();
             document.getElementById('event-id').value = ''; // Clear hidden ID for add mode
             openModal(eventModal);
        });

        // Handle Event Form Submission (Add/Edit)
        eventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const eventId = document.getElementById('event-id').value; // Will be empty for add, ID for edit
            const title = document.getElementById('event-title').value.trim();
            const description = document.getElementById('event-description').value.trim();
            const imageUrl = document.getElementById('event-image-url').value.trim();
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const reward = document.getElementById('event-reward').value.trim();
            const link = document.getElementById('event-link').value.trim();
            const registrationLink = document.getElementById('event-registration-link').value.trim();

            eventFormMessage.classList.add('hidden');
            eventFormMessage.textContent = ''; // Clear message
            eventFormMessage.classList.remove('error-message', 'success-message', 'info-message');

             if (!title || !description || !date) {
                 eventFormMessage.textContent = 'Title, Description, and Date are required.';
                 eventFormMessage.classList.add('error-message');
                 eventFormMessage.classList.remove('hidden');
                 return;
             }

            const eventData = {
                title: title,
                description: description,
                imageUrl: imageUrl || null, // Save as null if empty
                date: date,
                time: time || null,
                reward: reward || null,
                link: link || null,
                registrationLink: registrationLink || null,
                createdAt: eventId ? undefined : firebase.database.ServerValue.TIMESTAMP // Only set createdAt on add
                // UpdatedAt could also be added here on both add and edit
            };

            let savePromise;
            if (eventId) {
                // Editing existing event
                savePromise = database.ref('events/' + eventId).update(eventData);
                 console.log(`Updating event: ${eventId}`, eventData);
            } else {
                // Adding new event
                savePromise = database.ref('events').push(eventData);
                 console.log("Adding new event", eventData);
            }

            savePromise.then(() => {
                 const action = eventId ? 'updated' : 'added';
                 console.log(`Event ${action} successfully.`);
                 eventFormMessage.textContent = `Event ${action} successfully!`;
                 eventFormMessage.classList.add('success-message');
                 eventFormMessage.classList.remove('hidden');
                 // Data table will update automatically due to 'on' listener

                 // Close modal after a short delay on success
                 setTimeout(() => {
                     closeModal(eventModal);
                 }, 1000);

            }).catch(error => {
                console.error("Error saving event:", error);
                eventFormMessage.textContent = `Failed to save event: ${error.message}`;
                eventFormMessage.classList.add('error-message');
                eventFormMessage.classList.remove('hidden');
            });
        });


        // Support Ticket Management
        function loadSupportTickets() {
             if (!supportTableBody) return; // Exit if element not found

             supportTableBody.innerHTML = ''; // Clear existing data
             supportTable.classList.add('hidden');
             noSupportMessage.classList.add('hidden');
             supportLoader.classList.remove('hidden');

             // Use 'on' for real-time updates
             if (window._supportTicketsListener) { // Detach previous listener if exists
                 database.ref('support_tickets').off('value', window._supportTicketsListener);
                 window._supportTicketsListener = null;
             }

             const supportTicketsCallback = (snapshot) => {
                 supportLoader.classList.add('hidden');
                 supportTableBody.innerHTML = ''; // Clear again for real-time updates

                 if (snapshot.exists()) {
                     const tickets = snapshot.val();
                     const ticketKeys = Object.keys(tickets);

                     if (ticketKeys.length === 0) {
                        noSupportMessage.classList.remove('hidden');
                        supportTable.classList.add('hidden');
                        return;
                    }

                     supportTable.classList.remove('hidden');
                     noSupportMessage.classList.add('hidden');

                     // Sort tickets by submittedAt timestamp (most recent first) - handled by orderByChild
                     // ticketKeys order is naturally sorted by key if not using orderByChild,
                     // but Firebase on('value') with orderByChild returns keys in that order.
                     // No need to reverse() here if orderByChild is used.


                     ticketKeys.forEach(key => {
                         const ticket = tickets[key];
                          // Default status if not set
                         const status = ticket.status || 'open';
                         // Add styling based on status
                         let statusColor = 'var(--text-medium)'; // Default
                         if (status === 'open') statusColor = '#f1c40f'; // Yellow/Amber for Open
                         else if (status === 'closed') statusColor = 'var(--primary-green)'; // Green for Closed
                         else if (status === 'in-progress') statusColor = '#3498db'; // Blue for In Progress


                         const row = `
                             <tr>
                                 <td data-label="Submitted By">${ticket.email || 'N/A'}</td>
                                 <td data-label="Subject">${ticket.subject || 'No Subject'}</td>
                                 <td data-label="Message" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${ticket.message || ''}">${ticket.message || 'No message'}</td>
                                 <td data-label="Status" style="color: ${statusColor}; font-weight: bold;">${status.charAt(0).toUpperCase() + status.slice(1)}</td>
                                 <td data-label="Submitted At">${formatTimestamp(ticket.submittedAt)}</td>
                                  <!-- Add Action buttons/dropdown for status change here later -->
                                  <!-- Example: <td data-label="Actions"><button data-id="${key}" data-status="${status}" class="btn btn-secondary btn-sm change-status-btn">Change Status</button></td> -->
                             </tr>
                         `;
                         supportTableBody.innerHTML += row;
                     });

                      // Optional: Attach listeners for status change buttons here if added above

                 } else {
                     noSupportMessage.classList.remove('hidden');
                     supportTable.classList.add('hidden');
                 }
             };

             database.ref('support_tickets').orderByChild('submittedAt').on('value', supportTicketsCallback, (error) => {
                console.error("Failed to load support tickets:", error);
                supportLoader.classList.add('hidden');
                noSupportMessage.classList.add('hidden');
                supportTable.classList.add('hidden');
                 if (supportTableBody) {
                    supportTableBody.innerHTML = `<tr><td colspan="5" class="error-message" data-label="Error">Failed to load tickets: ${error.message}</td></tr>`;
                 }
             });
              window._supportTicketsListener = supportTicketsCallback; // Store listener
        }


        // --- Modal Closing Event Listener ---
        // Using event delegation for all close buttons
         document.addEventListener('click', (e) => {
             const closeModalButton = e.target.closest('.close-modal-btn');
             if(closeModalButton){
                 const modalId = closeModalButton.getAttribute('data-modal-id');
                 const modalToClose = document.getElementById(modalId);
                 if(modalToClose) {
                    closeModal(modalToClose);
                 }
             }

             // Close modals if clicking directly on the modal backdrop (not content)
             if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
                 const modalContent = e.target.querySelector('.modal-content');
                 // Ensure the click wasn't inside the modal-content or on the modal-content itself
                 if (modalContent && !modalContent.contains(e.target) && e.target !== modalContent) {
                    closeModal(e.target);
                 } else if (!modalContent && e.target.classList.contains('modal')) { // Handle cases where modal-content might be missing, just close if it's the modal div
                    closeModal(e.target);
                 }
             }
         });


        // --- Access Denied Login Modal Handlers ---

        // Show the login modal when the link is clicked
        accessDeniedLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            openModal(accessDeniedLoginModal);
        });

        // Handle Email/Password Login from Access Denied modal
        accessDeniedLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('access-denied-email').value;
            const password = document.getElementById('access-denied-password').value;
            accessDeniedLoginError.classList.add('hidden');
            accessDeniedLoginError.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Email/Password login successful from Access Denied modal:", userCredential.user.uid);
                    // onAuthStateChanged will trigger and call checkAdminStatus,
                    // which will then show the admin panel if the user is an admin.
                    // If not an admin, onAuthStateChanged will call showAccessDenied again.
                    closeModal(accessDeniedLoginModal); // Close modal on successful auth (before admin check)
                })
                .catch((error) => {
                    accessDeniedLoginError.textContent = error.message;
                    accessDeniedLoginError.classList.remove('hidden');
                    console.error("Access Denied Login Error:", error);
                });
        });

        // Handle Google Login from Access Denied modal
         accessDeniedGoogleLoginBtn.addEventListener('click', () => {
             auth.signInWithPopup(googleProvider)
                .then((result) => {
                    console.log("Google login successful from Access Denied modal:", result.user.uid);
                     // onAuthStateChanged will trigger and call checkAdminStatus
                    closeModal(accessDeniedLoginModal); // Close modal on successful auth
                })
                .catch((error) => {
                    console.error("Access Denied Google Signin Error:", error);
                    const errorMessage = error.message;
                    accessDeniedLoginError.textContent = `Google Signin Error: ${errorMessage}`;
                    accessDeniedLoginError.classList.remove('hidden');
                });
         });


        // --- Initial Load ---
        // onAuthStateChanged will handle showing access denied or panel
        // No explicit initial call to show a screen here, onAuthStateChanged handles it based on initial auth state.

    }); // End DOMContentLoaded
    </script>
</body>
</html>